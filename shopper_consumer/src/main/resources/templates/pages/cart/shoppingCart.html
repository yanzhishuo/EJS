<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>购物车</title>
<title>商品详情</title><link rel="stylesheet" type="text/css" th:href="@{/EJS/shopperConsumer/css/style.css}" />
<link rel="stylesheet" type="text/css" th:href="@{/EJS/shopperConsumer/css/shopping-mall-index.css}" />
<script type="text/javascript" th:src="@{/EJS/shopperConsumer/js/jquery.js}"></script>
<script type="text/javascript" th:src="@{/EJS/shopperConsumer/js/zhonglin.js}"></script>
</head>

<body style="position:relative;">

	<!--top 开始-->
    <div class="top">
    	<div class="top-con w1200">
        	<p class="t-con-l f-l">您好，欢迎来到宅客微购</p>
            <ul class="t-con-r f-r">
            	<li><a href="#">我 (个人中心)</a></li>
            	<li><a href="/EJS/shopperConsumer/cartPage">我的购物车</a></li>
            	<li><a href="#">我的订单</a></li>
            	<li class="erweima">
                	<a href="#">扫描二维码</a>
                    <div class="ewm-tu">
                    	<a href="#"><img src="images/erweima-tu.jpg" /></a>
                    </div>
                </li>
                <div style="clear:both;"></div>
            </ul>
            <div style="clear:both;"></div>
        </div>
    </div>
    
    <!--logo search 开始-->
    <div class="hd-info1 w1200">
    	<div class="logo f-l">
        	<h1><a href="#" title="中林网站"><img width="100px" height="126px" src="images/homePage/logo.jpg" /></a></h1>
        </div>
        <div class="search f-r">
        	<ul class="sp">
            	<li class="current" ss-search="sp"><a href="JavaScript:;">商品</a></li>
                <li ss-search="dp"><a href="JavaScript:;">店铺</a></li>
                <div style="clear:both;"></div>
            </ul>
            <div class="srh">
            	<div class="ipt f-l">
                	<input type="text" placeholder="搜索商品..." ss-search-show="sp" />
                    <input type="text" placeholder="搜索店铺..." ss-search-show="dp" style="display:none;" />
                </div>
                <button class="f-r">搜 索</button>
                <div style="clear:both;"></div>
            </div>
            <ul class="sp2">
                <li><a href="#">绿豆</a></li>
                <li><a href="#">大米</a></li>
                <li><a href="#">驱蚊</a></li>
                <li><a href="#">洗面奶</a></li>
                <li><a href="#">格力空调</a></li>
                <li><a href="#">洗发护发</a></li>
                <li><a href="#">葡萄 </a></li>
                <li><a href="#">脉动</a></li>
                <li><a href="#">海鲜水产</a></li>
                <div style="clear:both;"></div>
            </ul>
        </div>
        <div style="clear:both;"></div>
    </div>
    
    <!--切换城市-->
    <div class="switch-city w1200">
    	<a href="#" class="dianji-qh">切换城市</a>
        <span class="dqm">重庆市</span>
        <div class="select-city">
        	<div class="sl-city-top">
            	<p class="f-l">切换城市</p>
                <a class="close-select-city f-r" href="#">
                	<img src="images/close-select-city.gif" />
                </a>
            </div>
            <div class="sl-city-con">
            	<p>西北</p>
                <dl>
                	<dt>重庆市</dt>
                    <dd>
                    	<a href="#">长寿区</a>
                        <a href="#">巴南区</a>
                        <a href="#">南岸区</a>
                        <a href="#">九龙坡区</a>
                        <a href="#">沙坪坝区</a>
                        <a href="#">北碚</a>
                        <a href="#">江北区</a>
                        <a href="#">渝北区</a>
                        <a href="#">大渡口区</a>
                        <a href="#">渝中区</a>
                        <a href="#">万州</a>
                        <a href="#">武隆</a>
                        <a href="#">晏家</a>
                        <a href="#">长寿湖</a>
                        <a href="#">云集</a>
                        <a href="#">华中</a>
                        <a href="#">林封</a>
                        <a href="#">双龙</a>
                        <a href="#">石回</a>
                        <a href="#">龙凤呈祥</a>
                        <a href="#">朝天门</a>
                        <a href="#">中华</a>
                        <a href="#">玉溪</a>
                        <a href="#">云烟</a>
                        <a href="#">红塔山</a>
                        <a href="#">真龙</a>
                        <a href="#">天子</a>
                        <a href="#">娇子</a>
                    </dd>
                    <div style="clear:both;"></div>
                </dl>
                <dl>
                	<dt>新疆</dt>
                    <dd>
                    	<a href="#">齐乌鲁木</a>
                        <a href="#">昌吉</a>
                        <a href="#">巴音</a>
                        <a href="#">郭楞</a>
                        <a href="#">伊犁</a>
                        <a href="#">阿克苏</a>
                        <a href="#">喀什</a>
                        <a href="#">哈密</a>
                        <a href="#">克拉玛依</a>
                        <a href="#">博尔塔拉</a>
                        <a href="#">吐鲁番</a>
                        <a href="#">和田</a>
                        <a href="#">石河子</a>
                        <a href="#">克孜勒苏</a>
                        <a href="#">阿拉尔</a>
                        <a href="#">五家渠</a>
                        <a href="#">图木舒克</a>
                        <a href="#">库尔勒</a>
                    </dd>
                    <div style="clear:both;"></div>
                </dl>
                <dl>
                	<dt>甘肃</dt>
                    <dd>
                    	<a href="#">兰州</a>
                        <a href="#">天水</a>
                        <a href="#">巴音</a>
                        <a href="#">白银</a>
                        <a href="#">庆阳</a>
                        <a href="#">平凉</a>
                        <a href="#">酒泉</a>
                        <a href="#">张掖</a>
                        <a href="#">武威</a>
                        <a href="#">定西</a>
                        <a href="#">金昌</a>
                        <a href="#">陇南</a>
                        <a href="#">临夏</a>
                        <a href="#">嘉峪关</a>
                        <a href="#">甘南</a>
                    </dd>
                    <div style="clear:both;"></div>
                </dl>
                <dl>
                	<dt>宁夏</dt>
                    <dd>
                    	<a href="#">银川</a>
                        <a href="#">吴忠</a>
                        <a href="#">石嘴山</a>
                        <a href="#">中卫</a>
                        <a href="#">固原</a>
                    </dd>
                    <div style="clear:both;"></div>
                </dl>
                <dl>
                	<dt>青海</dt>
                    <dd>
                    	<a href="#">西宁</a>
                        <a href="#">海西</a>
                        <a href="#">海北</a>
                        <a href="#">果洛</a>
                        <a href="#">海东</a>
                        <a href="#">黄南</a>
                        <a href="#">玉树</a>
                        <a href="#">海南</a>
                    </dd>
                    <div style="clear:both;"></div>
                </dl>
            </div>
        </div>
    </div>
    
    <!--内容开始-->
    <div class="cart-content w1200">
    	<ul class="cart-tit-nav">
        	<li class="current"><a href="#">全部商品   21</a></li>
        	<li><a href="#">降价商品   1</a></li>
        	<li><a href="#">进口商品   1</a></li>
            <div style="clear:both;"></div>
        </ul>
        <div class="cart-con-tit">
        	<p class="p1">
            	<input type="checkbox" id="selectAllTop" value="" name="hobby1" onclick="selectAll()"></input>
				<span>全选</span>
            </p>
            <p class="p2">商品信息</p>
            <p class="p3">规格</p>
            <p class="p4">数量</p>
            <p class="p5">单价（元）</p>
            <p class="p6">金额（元）</p>
            <p class="p7">操作</p>
        </div>
        <div id="shoppingCartList"></div>

        <!--分页-->
        <div class="paging" style="margin-left: 0px; width: 1200px" >
            	<div class="pag-right f-r" style="margin-left: 0px; width: 1500px" >
                    <button class="f-r" style="margin-left: 20px" onclick="checkOut()">结算</button>
                    <button class="f-r" style="width: 100px" onclick="deleteAll()">一键清空</button>
                    <div style="clear:both;"></div>
                </div>
                <div style="clear:both;"></div>
            </div>
       	<div class="cart-con-footer">
        	<input type="checkbox" id="selectAllBottom" value="" name="hobby2" onclick="selectAll2()"></input>
			<span>全选</span>
            <a href="#">删除</a>
            <a href="#">加入收藏夹</a>
            <p>（此处始终在屏幕下方）</p>
        </div>
    </div>
    
    <!--底部服务-->
    <div class="ft-service">
    	<div class="w1200">
        	<div class="sv-con-l2 f-l">
            	<dl>
                	<dt><a href="#">新手上路</a></dt>
                    <dd>
                    	<a href="#">购物流程</a>
                    	<a href="#">在线支付</a>
                    </dd>
                </dl>
                <dl>
                	<dt><a href="#">配送方式</a></dt>
                    <dd>
                    	<a href="#">货到付款区域</a>
                    	<a href="#">配送费标准</a>
                    </dd>
                </dl>
                <dl>
                	<dt><a href="#">购物指南</a></dt>
                    <dd>
                    	<a href="#">常见问题</a>
                    	<a href="#">订购流程</a>
                    </dd>
                </dl>
                <dl>
                	<dt><a href="#">售后服务</a></dt>
                    <dd>
                    	<a href="#">售后服务保障</a>
                    	<a href="#">退款说明</a>
                    	<a href="#">新手选购商品总则</a>
                    </dd>
                </dl>
                <dl>
                	<dt><a href="#">关于我们</a></dt>
                    <dd>
                    	<a href="#">投诉与建议</a>
                    </dd>
                </dl>
                <div style="clear:both;"></div>
            </div>
        	<div class="sv-con-r2 f-r">
            	<p class="sv-r-tle">187-8660-5539</p>
            	<p>周一至周五9:00-17:30</p>
            	<p>（仅收市话费）</p>
            	<a href="#" class="zxkf">24小时在线客服</a>
            </div>
            <div style="clear:both;"></div>
        </div>
    </div>
    
    <!--底部 版权-->
    <div class="footer w1200">
    	<p>
        	<a href="#">关于我们</a><span>|</span>
        	<a href="#">友情链接</a><span>|</span>
        	<a href="#">宅客微购社区</a><span>|</span>
        	<a href="#">诚征英才</a><span>|</span>
        	<a href="#">商家登录</a><span>|</span>
        	<a href="#">供应商登录</a><span>|</span>
        	<a href="#">热门搜索</a><span>|</span>
        	<a href="#">宅客微购新品</a><span>|</span>
        	<a href="#">开放平台</a>
        </p>
        <p>
        	沪ICP备13044278号<span>|</span>合字B1.B2-20130004<span>|</span>营业执照<span>|</span>互联网药品信息服务资格证<span>|</span>互联网药品交易服务资格证
        </p>
    </div>
<script type="text/javascript">
    var userLoginId = 55;//用户id
    queryProductByCategory();
    //根据类别加载相应的数据
    function queryProductByCategory(){
        $.ajax({
            async: false,
            url: '/EJS/shopperConsumer/cartList',
            data: {"userLoginId": userLoginId},
            dataType: 'json',
            success: function (result) {
                renderCartHtml(result);
            }
        });
    }

    //渲染项链模块页面
    function renderCartHtml(data) {
        var productHtml = "";//用来存储html内容
        //alert(data.length);
        $.each(data, function (k, o) {
            //var productDetailId = k;
            var num = o.userShoppingCartProductNum;
            var price = o.productDetail.productDetailPrice;
            productHtml += "<div class=\"cart-con-info\">";
            productHtml += "<div class=\"info-mid\">";
            productHtml += "<input type='checkbox' class=\"mid-ipt f-l\" value='"+o.userShoppingCartId+"' name='hobby' id='hobby"+k+"' onclick='select("+k+")'></input>";
            productHtml += "<div class=\"mid-tu f-l\">";
            productHtml += "<a href=\"#\"><img width='95px' height='100px' src='"+o.productDetail.productDetailImage+"' /></a>";
            productHtml += "</div>";
            productHtml += "<div class=\"mid-font f-l\">";
            productHtml += "<a href=\"#\" style='width: 215px'>"+o.productName+"</a>";
            if(o.productDetail.productDetailStatus == 3){
                productHtml += "<span>商品已下架</span>";}
            if(o.productDetail.productDetailStock - o.userShoppingCartProductNum < 0){
                productHtml += "<span>库存不足</span>";}
            else if(o.productDetail.productDetailStock - o.userShoppingCartProductNum <= 3){
                productHtml += "<span>库存紧张</span>";}
            productHtml += "</div>";
            productHtml += "<div class=\"mid-guige f-l\">";
            productHtml += "<p>"+o.productDetail.productPropertyName+"："+o.productDetail.productPropertyValue+"</p>";
            productHtml += "</div>";
            productHtml += "<div class=\"mid-sl f-l\">";
            productHtml += "<a href=\"JavaScript:;\" onclick='minus("+k+","+o.productDetail.productDetailStock+","+price+")'>-</a>";
            productHtml += "<input type=\"text\" readonly='true' value='"+o.userShoppingCartProductNum+"' id='productNum"+k+"'/>";
            productHtml += "<a href=\"JavaScript:;\" onclick='add("+k+","+o.productDetail.productDetailStock+","+price+")'>+</a>";
            productHtml += "</div>";
            productHtml += "<p class=\"mid-dj f-l\">"+ price +"</p>";
            productHtml += "<p class=\"mid-je f-l\" id='total"+k+"'>"+ num*price +"</p>";
            productHtml += "<div class=\"mid-chaozuo f-l\">";
            productHtml += "<a href=\"#\">移入收藏夹</a>";
            productHtml += "<button class=\"f-r\" class=\"f-r\" onclick='deleteProduct("+ k +")'>删除</button>";
            productHtml += "</div>";
            productHtml += "<div style=\"clear:both;\"></div>";
            productHtml += "</div>";
            productHtml += "</div>";

        });
        $("#shoppingCartList").html(productHtml);
    }
    //结算
    function checkOut(){
        if(getSelectValue().length==0){
            alert("请先选择商品");
        }else{
            //所有选中商品的cartid
            alert(getSelectValue());
        }

    }
    //得到所有选中的cartid
    function getSelectValue(){
        var cartIdArray = new Array();
        //获取name=box的复选框
        var boxs = document.getElementsByName("hobby");
        //遍历所有的复选框
        for(var i = 0; i < boxs.length; i++) {
            if(boxs[i].checked) {
                cartIdArray.push(boxs[i].value);
            }
        }
        return cartIdArray;
    }
    //全选 顶部
    function selectAll(){
        //选中全选按钮
        var box = document.getElementById("selectAllTop");
        var box2 = document.getElementById("selectAllBottom");
        var boxs = document.getElementsByName("hobby");
        if(box.checked){
            box2.checked = true;
            for(var i = 0; i < boxs.length; i++) {
                boxs[i].checked = true;
            }
        }else {
            box2.checked = false;
            for(var i = 0; i < boxs.length; i++) {
                boxs[i].checked = false;
            }
        }
    }

    //全选 底部
    function selectAll2(){
        //选中全选按钮
        var box = document.getElementById("selectAllTop");
        var box2 = document.getElementById("selectAllBottom");
        var boxs = document.getElementsByName("hobby");
        if(box2.checked){
            box.checked = true;
            for(var i = 0; i < boxs.length; i++) {
                boxs[i].checked = true;
            }
        }else {
            box.checked = false;
            for(var i = 0; i < boxs.length; i++) {
                boxs[i].checked = false;
            }
        }
    }
    //单个选择事件
    function select(id){
        alert(1);
        var box = document.getElementById("hobby"+id);
        var box1 = document.getElementById("selectAllTop");
        var box2 = document.getElementById("selectAllBottom");
        if(box.checked){
            box.checked = false;
        }else{
            box.checked = true;
        }
        var boxs = document.getElementsByName("hobby");
        var count = 0;
        for(var i = 0; i < boxs.length; i++) {
            if(boxs[i].checked = true)
                count++;
        }
        alert(count);
        if(count == boxs.length){
            box1.checked = true;
            box2.checked = true;
        }else{
            box1.checked = false;
            box2.checked = false;
        }
    }
    function deleteProduct(productDetailId){
        $.ajax({
            async: false,
            url: '/EJS/shopperConsumer/removeOneItemFromCart',
            data: {
                "productDetailId": productDetailId,
                "userLoginId": userLoginId
            },
            dataType: 'text',
            success: function (result) {
                if(result == "success"){
                    queryProductByCategory();
                }
            }
        });
    }
    function minus(id, stock, price){
        var buttonId = 'productNum'+id;
        var num = document.getElementById(buttonId).value;
        if(num > 1){
            num--;
            document.getElementById(buttonId).value = num;
        }
        if(num > stock){
            alert("数量超出库存范围~");
            num = stock;
            document.getElementById(buttonId).value = num;
        }
        $("#total"+id).text(num*price);
        modifyProductNum(id, num);
    }
    //修改数量时判断是否超出库存范围
    function add(id, stock, price){
        var buttonId = 'productNum'+id;
        var num = document.getElementById(buttonId).value;
        if(num >= stock){
            alert("数量超出库存范围~");
        }else{
            num++;
        }
        document.getElementById(buttonId).value = num;
        $("#total"+id).text(num*price);
        modifyProductNum(id, num);
    }
    //商品数量变化时，更改数据库与Redis中相应的数据
    function modifyProductNum(id, num){
        $.ajax({
            url: '/EJS/shopperConsumer/modifyProductNum',
            data: {
                "userLoginId": userLoginId,
                "productDetailId":id,
                "productNum": num
            },
            dataType: 'text',
            success: function (result) {
                if(result == "success"){
                    //queryProductByCategory();
                }
            }
        });
    }
    function deleteAll(){
        //removeUserCart
        $.ajax({
            url: '/EJS/shopperConsumer/removeUserCart',
            data: {
                "userLoginId": userLoginId
            },
            dataType: 'text',
            success: function (result) {
                if(result == "success"){
                    queryProductByCategory();
                }
            }
        });
    }
</script>
</body>
</html>
